---
// Lightbox component - click images to view full-size, with arrow navigation
---

<div class="lightbox" id="lightbox" aria-hidden="true" role="dialog" aria-label="Image preview">
  <button class="lightbox-close" aria-label="Close image preview">&times;</button>
  <button class="lightbox-prev" aria-label="Previous image">&#8249;</button>
  <button class="lightbox-next" aria-label="Next image">&#8250;</button>
  <img class="lightbox-image" src="" alt="" />
  <span class="lightbox-counter"></span>
</div>

<style>
  .lightbox {
    position: fixed;
    inset: 0;
    z-index: 1000;
    background-color: rgba(0, 0, 0, 0.95);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: var(--spacing-md);
    opacity: 0;
    visibility: hidden;
    transition: opacity var(--transition-base), visibility var(--transition-base);
    cursor: zoom-out;
  }

  .lightbox.active {
    opacity: 1;
    visibility: visible;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    border-radius: var(--radius-sm);
    transform: scale(0.95);
    transition: transform var(--transition-base);
  }

  .lightbox.active .lightbox-image {
    transform: scale(1);
  }

  .lightbox-close {
    position: absolute;
    top: var(--spacing-md);
    right: var(--spacing-md);
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: var(--text-primary);
    font-size: 2rem;
    cursor: pointer;
    transition: background-color var(--transition-fast);
    z-index: 2;
  }

  .lightbox-close:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .lightbox-close:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .lightbox-prev,
  .lightbox-next {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 48px;
    height: 48px;
    display: none;
    align-items: center;
    justify-content: center;
    background-color: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: var(--text-primary);
    font-size: 2rem;
    cursor: pointer;
    transition: background-color var(--transition-fast);
    z-index: 2;
  }

  .lightbox-prev {
    left: var(--spacing-md);
  }

  .lightbox-next {
    right: var(--spacing-md);
  }

  .lightbox-prev:hover,
  .lightbox-next:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .lightbox-prev:focus-visible,
  .lightbox-next:focus-visible {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }

  .lightbox.has-nav .lightbox-prev,
  .lightbox.has-nav .lightbox-next {
    display: flex;
  }

  .lightbox-counter {
    position: absolute;
    bottom: var(--spacing-md);
    left: 50%;
    transform: translateX(-50%);
    font-size: var(--font-size-sm);
    color: var(--text-muted);
    display: none;
    z-index: 2;
  }

  .lightbox.has-nav .lightbox-counter {
    display: block;
  }

  @media (max-width: 768px) {
    .lightbox {
      padding: var(--spacing-xs);
    }

    .lightbox-prev,
    .lightbox-next {
      width: 36px;
      height: 36px;
      font-size: 1.5rem;
    }

    .lightbox-prev {
      left: var(--spacing-xs);
    }

    .lightbox-next {
      right: var(--spacing-xs);
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .lightbox,
    .lightbox-image {
      transition: none;
    }
  }
</style>

<style is:global>
  /* Make clickable images show pointer cursor */
  .zoomable {
    cursor: zoom-in;
    transition: transform var(--transition-fast);
  }

  .zoomable:hover {
    transform: scale(1.02);
  }

  @media (prefers-reduced-motion: reduce) {
    .zoomable:hover {
      transform: none;
    }
  }
</style>

<script>
  function initLightbox() {
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = lightbox?.querySelector('.lightbox-image') as HTMLImageElement;
    const lightboxClose = lightbox?.querySelector('.lightbox-close');
    const lightboxPrev = lightbox?.querySelector('.lightbox-prev');
    const lightboxNext = lightbox?.querySelector('.lightbox-next');
    const lightboxCounter = lightbox?.querySelector('.lightbox-counter');

    let currentImages: HTMLImageElement[] = [];
    let currentIndex = 0;

    function getScrollbarWidth() {
      return window.innerWidth - document.documentElement.clientWidth;
    }

    function updateNav() {
      if (currentImages.length > 1 && lightboxCounter) {
        lightbox?.classList.add('has-nav');
        lightboxCounter.textContent = `${currentIndex + 1} / ${currentImages.length}`;
      } else {
        lightbox?.classList.remove('has-nav');
      }
    }

    function openLightbox(src: string, alt: string) {
      if (lightbox && lightboxImage) {
        const scrollbarWidth = getScrollbarWidth();
        document.body.style.overflow = 'hidden';
        document.body.style.paddingRight = `${scrollbarWidth}px`;

        lightboxImage.src = src;
        lightboxImage.alt = alt;
        lightbox.classList.add('active');
        lightbox.setAttribute('aria-hidden', 'false');
        updateNav();

        // Preload adjacent
        if (currentImages.length > 1) {
          const prevIdx = (currentIndex - 1 + currentImages.length) % currentImages.length;
          const nextIdx = (currentIndex + 1) % currentImages.length;
          new Image().src = currentImages[prevIdx].src;
          new Image().src = currentImages[nextIdx].src;
        }
      }
    }

    function closeLightbox() {
      if (lightbox) {
        lightbox.classList.remove('active');
        lightbox.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
      }
    }

    function navigate(direction: number) {
      if (currentImages.length <= 1) return;
      currentIndex = (currentIndex + direction + currentImages.length) % currentImages.length;
      const img = currentImages[currentIndex];
      if (lightboxImage) {
        lightboxImage.src = img.src;
        lightboxImage.alt = img.alt;
      }
      updateNav();

      // Preload next in direction
      const preloadIdx = (currentIndex + direction + currentImages.length) % currentImages.length;
      new Image().src = currentImages[preloadIdx].src;
    }

    // Build image list from visible zoomable images
    function buildImageList(clickedImg: HTMLImageElement) {
      // Get all visible zoomable images (not hidden by filter)
      currentImages = Array.from(document.querySelectorAll('.zoomable')).filter(img => {
        const item = img.closest('.gallery-item');
        if (item && (item.classList.contains('hidden') || item.classList.contains('over-limit'))) return false;
        return (img as HTMLElement).offsetParent !== null;
      }) as HTMLImageElement[];

      currentIndex = currentImages.indexOf(clickedImg);
      if (currentIndex === -1) {
        currentImages = [clickedImg];
        currentIndex = 0;
      }
    }

    // Click on zoomable images
    document.querySelectorAll('.zoomable').forEach(img => {
      img.addEventListener('click', () => {
        const imgEl = img as HTMLImageElement;
        buildImageList(imgEl);
        openLightbox(imgEl.src, imgEl.alt);
      });
    });

    // Close on backdrop click
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) {
        closeLightbox();
      }
    });

    // Close button
    lightboxClose?.addEventListener('click', closeLightbox);

    // Nav buttons
    lightboxPrev?.addEventListener('click', (e) => {
      e.stopPropagation();
      navigate(-1);
    });

    lightboxNext?.addEventListener('click', (e) => {
      e.stopPropagation();
      navigate(1);
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (!lightbox?.classList.contains('active')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') navigate(-1);
      if (e.key === 'ArrowRight') navigate(1);
    });

    // Touch swipe support
    let touchStartX = 0;
    let touchEndX = 0;

    lightbox?.addEventListener('touchstart', (e) => {
      touchStartX = (e as TouchEvent).changedTouches[0].screenX;
    }, { passive: true });

    lightbox?.addEventListener('touchend', (e) => {
      touchEndX = (e as TouchEvent).changedTouches[0].screenX;
      const diff = touchStartX - touchEndX;
      if (Math.abs(diff) > 50) {
        navigate(diff > 0 ? 1 : -1);
      }
    }, { passive: true });
  }

  document.addEventListener('astro:page-load', initLightbox);
</script>
