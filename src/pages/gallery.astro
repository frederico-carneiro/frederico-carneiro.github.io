---
import BaseLayout from '../layouts/BaseLayout.astro';
import Lightbox from '../components/Lightbox.astro';
import siteConfig from '../content/site-config.json';

const categories = [
  { id: 'environments', label: 'Environment & Level Art', title: 'Environment & Level Art', desc: 'From blockout to final detail stage. Composition, lighting, mood, color and final detail pass.' },
  { id: 'weapons', label: 'Weapons', title: 'Weapons', desc: 'Full mid-poly in-game model, from blockout to textures.' },
  { id: 'weapon-concept', label: 'Weapon Concept Art', title: 'Weapon Concept Art', desc: 'Full weapon concept art design.' },
  { id: '3d-art', label: '3D & Concept Art', title: '3D & Concept Art', desc: 'Fully created assets from concept stage to 3D in-game model.' },
  { id: 'aska-arms', label: 'Aska FPP Arms', title: 'HIGHLIGHT: Aska FPP Arms', desc: 'Full hard-surface mid-poly in-game model of the Metal Eden Aska FPP arms.' },
];

const galleryItems = [
  // Environment & Level Art
  { src: '/images/gallery/environment-gifs/ME_M00_013.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment-gifs/ME_M01_038.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment-gifs/ME_M01_051.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment-gifs/ME_M02_001.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment-gifs/ME_M02_008.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment-gifs/ME_M02_016.mp4', alt: 'Metal Eden — Environment', category: 'environments', type: 'video' as const },
  { src: '/images/gallery/environment/MetalEden_shot_002.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_004.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_027.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_037.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_044.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_046.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_060.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_063.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_075.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_078.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_079.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_080.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_083.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_087.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_092.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_094.webp', alt: 'Metal Eden — Environment', category: 'environments' },
  { src: '/images/gallery/environment/MetalEden_shot_101.webp', alt: 'Metal Eden — Environment', category: 'environments' },

  // Weapons
  { src: '/images/gallery/weapons/AutoPistol_001.webp', alt: 'Metal Eden — Auto Pistol', category: 'weapons' },
  { src: '/images/gallery/weapons/AutoPistol_002.webp', alt: 'Metal Eden — Auto Pistol', category: 'weapons' },
  { src: '/images/gallery/weapons/armata1.webp', alt: 'Metal Eden — Armata', category: 'weapons' },
  { src: '/images/gallery/weapons/armata2.webp', alt: 'Metal Eden — Armata', category: 'weapons' },
  { src: '/images/gallery/weapons/hertz_002.webp', alt: 'Metal Eden — Hertz', category: 'weapons' },
  { src: '/images/gallery/weapons/hertz_003.webp', alt: 'Metal Eden — Hertz', category: 'weapons' },
  { src: '/images/gallery/weapons/Needler.webp', alt: 'Metal Eden — Needler', category: 'weapons' },
  { src: '/images/gallery/weapons/Needler1.webp', alt: 'Metal Eden — Needler', category: 'weapons' },
  { src: '/images/gallery/weapons/Needler2.webp', alt: 'Metal Eden — Needler', category: 'weapons' },
  { src: '/images/gallery/weapons/sniper01.webp', alt: 'Metal Eden — Sniper', category: 'weapons' },
  { src: '/images/gallery/weapons/sniper03.webp', alt: 'Metal Eden — Sniper', category: 'weapons' },

  // Weapon Concept Art
  { src: '/images/gallery/weapon-concept/frederico-carneiro-09.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },
  { src: '/images/gallery/weapon-concept/frederico-carneiro-10.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },
  { src: '/images/gallery/weapon-concept/frederico-carneiro-haze-escur-10.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },
  { src: '/images/gallery/weapon-concept/frederico-carneiro-haze-escur-11.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },
  { src: '/images/gallery/weapon-concept/frederico-carneiro-haze-escur-13.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },
  { src: '/images/gallery/weapon-concept/frederico-carneiro-revolver-11.webp', alt: 'Weapon Concept Art', category: 'weapon-concept' },

  // Aska FPP Arms
  { src: '/images/gallery/aska-arms/ASKA_FPP_Arms_007.mp4', alt: 'Aska — FPP Arms', category: 'aska-arms', type: 'video' as const },
  { src: '/images/gallery/aska-arms/ASKA_FPP_Arms_009.mp4', alt: 'Aska — FPP Arms', category: 'aska-arms', type: 'video' as const },
  { src: '/images/gallery/aska-arms/ME_ASKA_Arms_001.webp', alt: 'Aska — FPP Arms', category: 'aska-arms' },
  { src: '/images/gallery/aska-arms/ME_ASKA_Arms_005.webp', alt: 'Aska — FPP Arms', category: 'aska-arms' },
  { src: '/images/gallery/aska-arms/ME_ASKA_Arms_009.webp', alt: 'Aska — FPP Arms', category: 'aska-arms' },
  { src: '/images/gallery/aska-arms/0001-0250.mp4', alt: 'Aska — FPP Arms Turntable', category: 'aska-arms', type: 'video' as const },

  // 3D & Concept Art
  { src: '/images/gallery/3d/ME_ConceptArt_001.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_002.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_003.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_004.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_005.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_006.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_007.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_008.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_009.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_010.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_011.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_012.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_013.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
  { src: '/images/gallery/3d/ME_ConceptArt_014.webp', alt: 'Metal Eden — Concept Art', category: '3d-art' },
];
---

<BaseLayout title="Gallery" description="Gallery of work by Frederico Carneiro — Environment, Level, Weapon, 3D and Concept Art.">
  <Lightbox />

  <main class="gallery-page">
    <section class="gallery-hero">
      <div class="gallery-hero-bg">
        <img src="/images/gallery/gallery-hero.webp" alt="Gallery" loading="eager" width="1920" height="800" />
      </div>
      <div class="gallery-hero-overlay"></div>
      <div class="gallery-hero-content">
        <h1>Gallery</h1>
        <p class="gallery-intro">A selection of work across Environment, Level, Weapon, 3D and Concept Art.</p>
      </div>
    </section>

    <div class="gallery-filter-bar">
      <div class="container">
        <div class="filter-tabs" role="tablist">
          {categories.map((cat, i) => (
            <button
              class:list={['filter-tab', { active: i === 0 }]}
              data-filter={cat.id}
              role="tab"
              aria-selected={i === 0 ? 'true' : 'false'}
            >
              {cat.label}
            </button>
          ))}
        </div>
      </div>
    </div>

    <section class="gallery-grid-section">
      <div class="container">
        {categories.map((cat) => (
          cat.title && (
            <div class="category-desc" data-desc={cat.id} style={cat.id !== 'environments' ? 'display:none;' : ''}>
              <h2 class="category-desc-title">{cat.title}</h2>
              <p class="category-desc-text">{cat.desc}</p>
            </div>
          )
        ))}
        <div class="gallery-grid">
          {galleryItems.map((item, i) => (
            <div
              class:list={['gallery-item', { 'gallery-item--video': item.type === 'video' }]}
              data-category={item.category}
              data-index={i}
            >
              {item.type === 'video' ? (
                <video
                  src={item.src}
                  autoplay
                  loop
                  muted
                  playsinline
                  width="1920"
                  height="1080"
                />
              ) : (
                <img
                  src={item.src}
                  alt={item.alt}
                  loading={i < 6 ? 'eager' : 'lazy'}
                  class="zoomable"
                  width="1920"
                  height="1080"
                />
              )}
              <div class="gallery-item-overlay">
                <span class="gallery-item-title">{item.alt}</span>
              </div>
            </div>
          ))}
        </div>
        <button class="show-more-btn" style="display:none;" aria-expanded="false">
          Show More
        </button>
        <p class="gallery-empty" style="display:none;">No images in this category yet.</p>
        <div class="gallery-artstation">
          <a href={siteConfig.contact.artstation} target="_blank" rel="noopener noreferrer" class="artstation-link">
            Full Art available on ArtStation &rarr;
          </a>
        </div>
      </div>
    </section>
  </main>
</BaseLayout>

<style>
  .gallery-page {
    padding-top: 64px;
  }

  /* Hero */
  .gallery-hero {
    position: relative;
    min-height: 50vh;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    overflow: hidden;
  }

  .gallery-hero-bg {
    position: absolute;
    inset: 0;
    z-index: -2;
  }

  .gallery-hero-bg img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    animation: kenBurns 20s ease-in-out infinite alternate;
  }

  @keyframes kenBurns {
    0% { transform: scale(1); }
    100% { transform: scale(1.08); }
  }

  .gallery-hero-overlay {
    position: absolute;
    inset: 0;
    z-index: -1;
    background: linear-gradient(
      to bottom,
      rgba(14, 15, 17, 0.5) 0%,
      rgba(14, 15, 17, 0.3) 50%,
      rgba(14, 15, 17, 0.85) 100%
    );
  }

  .gallery-hero-content {
    padding: var(--spacing-xl) var(--spacing-md);
    padding-top: calc(64px + var(--spacing-xl));
  }

  .gallery-hero-content h1 {
    margin-bottom: var(--spacing-sm);
    text-shadow: 0 2px 20px rgba(0, 0, 0, 0.5);
  }

  .gallery-intro {
    font-size: var(--font-size-lg);
    color: var(--text-secondary);
    max-width: 500px;
    margin: 0 auto;
    line-height: var(--line-height-relaxed);
  }

  /* Filter Bar */
  .gallery-filter-bar {
    position: sticky;
    top: 64px;
    z-index: 50;
    background-color: rgba(14, 15, 17, 0.9);
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    border-bottom: 1px solid var(--border);
    padding: var(--spacing-sm) 0;
  }

  .filter-tabs {
    display: flex;
    gap: var(--spacing-xs);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
  }

  .filter-tabs::-webkit-scrollbar {
    display: none;
  }

  .filter-tab {
    background: none;
    border: none;
    font-family: inherit;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: var(--spacing-xs) var(--spacing-sm);
    min-height: 44px;
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: color var(--transition-fast), background-color var(--transition-fast);
    white-space: nowrap;
    flex-shrink: 0;
  }

  .filter-tab:hover {
    color: var(--text-secondary);
  }

  .filter-tab.active {
    color: var(--text-primary);
    background-color: var(--bg-secondary);
  }

  /* Category Description */
  .category-desc {
    margin-bottom: var(--spacing-md);
  }

  .category-desc-title {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--text-primary);
    margin-bottom: 6px;
  }

  .category-desc-text {
    font-size: var(--font-size-base);
    color: var(--text-secondary);
    line-height: var(--line-height-relaxed);
  }

  /* Gallery Grid */
  .gallery-grid-section {
    padding: var(--spacing-md) 0 var(--spacing-xl);
  }

  .gallery-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }

  .gallery-item {
    position: relative;
    overflow: hidden;
    border-radius: var(--radius-sm);
    aspect-ratio: 16 / 9;
    cursor: pointer;
  }

  .gallery-item.hidden {
    display: none;
  }

  .gallery-item.over-limit {
    display: none;
  }

  .gallery-item img,
  .gallery-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
    filter: brightness(0.75);
    transition: filter 0.3s ease, transform 0.3s ease;
  }

  .gallery-item:hover img,
  .gallery-item:hover video {
    filter: brightness(1);
    transform: scale(1.03);
  }

  .gallery-item-overlay {
    position: absolute;
    inset: 0;
    background: linear-gradient(to top, rgba(14, 15, 17, 0.7) 0%, transparent 50%);
    display: flex;
    align-items: flex-end;
    padding: var(--spacing-sm);
    opacity: 0;
    transition: opacity 0.3s ease;
    pointer-events: none;
  }

  .gallery-item:hover .gallery-item-overlay {
    opacity: 1;
  }

  .gallery-item-title {
    font-size: var(--font-size-sm);
    color: var(--text-primary);
    font-weight: var(--font-weight-medium);
  }

  /* Show More Button */
  .show-more-btn {
    display: block;
    margin: var(--spacing-md) auto 0;
    padding: 10px 28px;
    background: none;
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: var(--radius-md);
    color: var(--text-secondary);
    font-family: inherit;
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    cursor: pointer;
    transition: color var(--transition-fast), border-color var(--transition-fast);
  }

  .show-more-btn:hover {
    color: var(--text-primary);
    border-color: var(--accent);
  }

  .gallery-empty {
    text-align: center;
    font-size: var(--font-size-lg);
    color: var(--text-muted);
    padding: var(--spacing-xl) 0;
  }

  .gallery-artstation {
    text-align: center;
    margin-top: var(--spacing-lg);
    padding-top: var(--spacing-md);
    border-top: 1px solid var(--border);
  }

  .artstation-link {
    font-size: var(--font-size-sm);
    font-weight: var(--font-weight-medium);
    color: var(--text-secondary);
    transition: color var(--transition-fast);
  }

  .artstation-link:hover {
    color: var(--accent);
  }

  /* Responsive */
  @media (max-width: 768px) {
    .gallery-hero {
      min-height: 40vh;
    }

    .gallery-grid {
      gap: 6px;
    }

    .gallery-item-overlay {
      opacity: 1;
    }

    .gallery-item img {
      filter: brightness(0.85);
    }
  }

  @media (max-width: 480px) {
    .gallery-grid {
      grid-template-columns: 1fr;
    }
  }

  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .gallery-item img {
      transition: none;
    }

    .gallery-item:hover img {
      transform: none;
    }
  }
</style>

<script>
  function initGallery() {
    const INITIAL_VISIBLE = 6;
    const tabs = document.querySelectorAll('.filter-tab');
    const items = document.querySelectorAll('.gallery-item');
    const showMoreBtn = document.querySelector('.show-more-btn') as HTMLButtonElement;
    const emptyMsg = document.querySelector('.gallery-empty') as HTMLElement;
    const descs = document.querySelectorAll('.category-desc');
    let currentFilter = 'environments';
    let expanded = false;

    function applyFilter() {
      let visibleCount = 0;
      let totalInCategory = 0;

      items.forEach(item => {
        const category = (item as HTMLElement).dataset.category;
        const matchesFilter = category === currentFilter;

        // Remove both classes first
        item.classList.remove('hidden', 'over-limit');

        if (!matchesFilter) {
          item.classList.add('hidden');
        } else {
          totalInCategory++;
          if (!expanded && totalInCategory > INITIAL_VISIBLE) {
            item.classList.add('over-limit');
          } else {
            visibleCount++;
          }
        }
      });

      // Show/hide "Show More" button
      const hiddenCount = totalInCategory - Math.min(totalInCategory, expanded ? totalInCategory : INITIAL_VISIBLE);
      if (hiddenCount > 0 && !expanded) {
        showMoreBtn.style.display = 'block';
        showMoreBtn.textContent = `Show More (${hiddenCount} more)`;
      } else {
        showMoreBtn.style.display = 'none';
      }

      // Show/hide category descriptions
      descs.forEach(desc => {
        const descCat = (desc as HTMLElement).dataset.desc;
        (desc as HTMLElement).style.display = descCat === currentFilter ? '' : 'none';
      });

      // Show empty message if no items
      if (emptyMsg) {
        emptyMsg.style.display = totalInCategory === 0 ? 'block' : 'none';
      }
    }

    tabs.forEach(tab => {
      tab.addEventListener('click', () => {
        const filter = (tab as HTMLElement).dataset.filter || 'environments';

        // Update active tab
        tabs.forEach(t => {
          t.classList.remove('active');
          t.setAttribute('aria-selected', 'false');
        });
        tab.classList.add('active');
        tab.setAttribute('aria-selected', 'true');

        // Update URL hash
        history.replaceState(null, '', `#${filter}`);

        // Reset expanded state when switching tabs
        currentFilter = filter;
        expanded = false;
        applyFilter();
      });
    });

    // Show More button
    showMoreBtn?.addEventListener('click', () => {
      expanded = true;
      showMoreBtn.setAttribute('aria-expanded', 'true');
      applyFilter();
    });

    // Check URL hash on load
    const hash = window.location.hash.replace('#', '');
    if (hash) {
      const matchingTab = document.querySelector(`.filter-tab[data-filter="${hash}"]`) as HTMLElement;
      if (matchingTab) {
        matchingTab.click();
        return;
      }
    }

    // Initial render
    applyFilter();
  }

  document.addEventListener('astro:page-load', initGallery);
</script>
